<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tufted Rug Quote Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600&family=Rubik+Bubbles&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #B1614E;
      --background: #F4F4F4;
      --font-main: 'Nunito', sans-serif;
      --font-heading: 'Rubik Bubbles', cursive;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-main);
      background: var(--background);
      padding: 2rem;
      color: #333;
    }

    h1 {
      font-family: var(--font-heading);
      font-size: 2.5rem;
      color: var(--accent);
      margin-bottom: 2rem;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
    }

    .form-card {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 100%;
      z-index: 1;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    input[type="number"], select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #CCC;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: var(--font-main);
    }

    input:focus, select:focus {
      border-color: var(--accent);
      outline: none;
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }

    button {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: var(--font-main);
      cursor: pointer;
      border: none;
    }

    .primary {
      background: var(--accent);
      color: white;
    }

    .primary:hover {
      opacity: 0.9;
    }

    .secondary {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }

    .secondary:hover {
      background: var(--accent);
      color: white;
    }

    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 300px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 12px rgba(0,0,0,0.2);
      padding: 2rem;
      transition: transform 0.3s ease;
      z-index: 1001;
    }

    .settings-panel.hidden {
      transform: translateX(100%);
    }

    .settings-panel.visible {
      transform: translateX(0);
    }

    .settings-toggle {
      display: none;
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 2rem;
      z-index: 1002;
      cursor: pointer;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: none;
    }

    .overlay.visible {
      display: block;
    }

    @media (min-width: 768px) {
      .settings-toggle {
        display: none;
      }

      .settings-panel {
        position: static;
        transform: none !important;
        height: auto;
        box-shadow: none;
      }

      .overlay {
        display: none !important;
      }

      .container {
        justify-content: center;
        align-items: flex-start;
      }

      .form-card {
        flex: 1 1 500px;
      }

      .settings-panel {
        flex: 0 0 300px;
      }

      .settings-toggle {
        display: none;
      }
    }

    @media (max-width: 767px) {
      .settings-toggle {
        display: block;
      }
    }
  </style>
</head>
<body>
  <h1 id="tool-title">Tufted Rug Quote Tool</h1>

  <button id="toggleSettings" class="settings-toggle" aria-label="Toggle Settings">&#9776;</button>

  <div class="overlay" id="overlay"></div>

  <div class="container">
    <form class="form-card" id="rugForm">
      <div class="form-group">
        <label for="length">Length (inches)</label>
        <input type="number" id="length" name="length" required />
      </div>
      <div class="form-group">
        <label for="width">Width (inches)</label>
        <input type="number" id="width" name="width" required />
      </div>
      <div class="form-group">
        <label for="backing">Backing Type</label>
        <select id="backing" name="backing">
          <option value="none">None</option>
          <option value="felt">Felt</option>
          <option value="latex">Latex</option>
        </select>
      </div>
      <div class="form-group">
        <label for="yarn">Yarn Type</label>
        <select id="yarn" name="yarn">
          <option value="acrylic">Acrylic</option>
          <option value="wool">Wool</option>
        </select>
      </div>
      <div class="button-group">
        <button type="submit" class="primary">Calculate</button>
        <button type="reset" class="secondary">Reset</button>
      </div>
    </form>

    <aside class="settings-panel hidden" id="settingsPanel">
      <h2 style="margin-bottom:1rem;">Settings</h2>
      <div class="form-group">
        <label for="currency">Currency</label>
        <select id="currency">
          <option value="USD">$ USD</option>
          <option value="KES">KSh KES</option>
        </select>
      </div>
      <div class="form-group">
        <label for="rate">Base Rate</label>
        <input type="number" id="rate" value="1.25" />
      </div>
      <button id="closeSettings" class="secondary" style="margin-top:1rem;">Close</button>
    </aside>
  </div>

  <script>
    const toggleBtn = document.getElementById("toggleSettings");
    const settingsPanel = document.getElementById("settingsPanel");
    const closeSettings = document.getElementById("closeSettings");
    const overlay = document.getElementById("overlay");

    toggleBtn.addEventListener("click", () => {
      settingsPanel.classList.add("visible");
      settingsPanel.classList.remove("hidden");
      overlay.classList.add("visible");
    });

    closeSettings.addEventListener("click", () => {
      settingsPanel.classList.remove("visible");
      settingsPanel.classList.add("hidden");
      overlay.classList.remove("visible");
    });

    overlay.addEventListener("click", () => {
      settingsPanel.classList.remove("visible");
      settingsPanel.classList.add("hidden");
      overlay.classList.remove("visible");
    });

    // Persist user preferences
    const currencySelect = document.getElementById("currency");
    const rateInput = document.getElementById("rate");

    function saveSettings() {
      localStorage.setItem("rugCurrency", currencySelect.value);
      localStorage.setItem("rugRate", rateInput.value);
    }

    function loadSettings() {
      const savedCurrency = localStorage.getItem("rugCurrency");
      const savedRate = localStorage.getItem("rugRate");

      if (savedCurrency) currencySelect.value = savedCurrency;
      if (savedRate) rateInput.value = savedRate;
    }

    currencySelect.addEventListener("change", saveSettings);
    rateInput.addEventListener("input", saveSettings);

    loadSettings();

    // --- Utility & Constants ---
    const SHEETS_WEBHOOK_URL = 'YOUR_SHEETS_WEBHOOK_URL';
    function $(id){return document.getElementById(id);}
    function showNotification(message, type='success') {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = message;
      $('toast-container').appendChild(t);
      setTimeout(() => t.remove(), 4000);
    }
    function validateInput(id, name, min=0) {
      const el = $(id), val = parseFloat(el.value);
      el.nextElementSibling?.classList?.contains('error-text') && el.nextElementSibling.remove();
      if (isNaN(val) || val < min) {
        const e = document.createElement('div'); e.className='error-text'; e.textContent=`${name} must be â‰¥ ${min}`;
        el.after(e);
        return false;
      }
      return true;
    }
    function validateAllInputs() {
      return [
        validateInput('tuftCloth','Tuft Cloth'),
        validateInput('yarn','Yarn'),
        validateInput('gluePer750ml','Glue Price'),
        validateInput('glueUsage','Glue Usage'),
        validateInput('backing','Backing'),
        validateInput('miscCost','Miscellaneous Cost'),
        validateInput('hourlyRate','Hourly Rate'),
        validateInput('length','Length',0.1),
        validateInput('width','Width',0.1)
      ].every(v=>v);
    }

    // --- Calculation & Display ---
    async function calculatePrice() {
      if (!validateAllInputs()) {
        showNotification('Please correct input errors before calculating.','error');
        return;
      }
      const length = parseFloat($('length').value),
            width = parseFloat($('width').value),
            complexity = $('complexity').value,
            pileType = $('pile').value,
            experience = $('experience').value,
            rushOrder = $('rush').value;
      const tuftCloth = +$('tuftCloth').value,
            yarn = +$('yarn').value,
            gluePricePer750ml = +$('gluePer750ml').value,
            glueUsagePerM2 = +$('glueUsage').value,
            backing = +$('backing').value,
            hourlyRate = +$('hourlyRate').value,
            misc = +$('miscCost').value;
      const areaFt = length * width,
            areaM2 = areaFt * 0.092903;
      const tuftClothCost = areaM2 * tuftCloth * 1.15;
      const yarnCoverage = pileType==='cut'?0.2:0.3;
      const yarnCost = (areaFt / yarnCoverage) * yarn;
      const glueCost = (glueUsagePerM2 * areaM2 / 750) * gluePricePer750ml;
      const backingCost = areaM2 * backing;
      const baseMat = tuftClothCost + yarnCost + glueCost + backingCost + misc;
      const withOH = baseMat * 1.2;
      const timeEstimates = { simple:2, medium:4, complex:6 };
      const experienceMultipliers = { beginner:1.3, intermediate:1.2, advanced:1 };
      const profitMargins = { simple:0.15, medium:0.2, complex:0.25 };
      const baseTuft = timeEstimates[complexity],
            totalTime = (baseTuft + 2.5 + 0.5) * experienceMultipliers[experience],
            labor = totalTime * hourlyRate;
      const subtotal = withOH + labor,
            profit = subtotal * profitMargins[complexity],
            final = subtotal + profit + (rushOrder==='yes'?subtotal*0.25:0);
      displayResults({ materials: baseMat, overhead: withOH-baseMat, labor, profit, finalPrice: final });
      showNotification('Calculation successful!','success');
      // Logging
      try {
        const res = await fetch(SHEETS_WEBHOOK_URL, { method:'POST', body: JSON.stringify({ length, width, final }) });
        showNotification(res.ok?'Quote saved successfully!':'Quote saved locally only','success');
      } catch(e) {
        showNotification('Quote calculated but not saved.','error');
      }
    }
    function displayResults({materials, overhead, labor, profit, finalPrice}) {
      $('resMaterials').textContent = `Ksh ${materials.toFixed(0)}`;
      $('resOverhead').textContent = `Ksh ${overhead.toFixed(0)}`;
      $('resLabor').textContent = `Ksh ${labor.toFixed(0)}`;
      $('resProfit').textContent = `Ksh ${profit.toFixed(0)}`;
      $('resFinal').textContent = `Ksh ${finalPrice.toFixed(0)}`;
      $('results').classList.add('show');
      $('download').style.display = 'inline-block';
    }
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`Final Quote: ${$('resFinal').textContent}`, 20, 20);
      doc.save('TuftedRugQuote.pdf');
      showNotification('PDF downloaded!','success');
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      $('calculate').addEventListener('click', calculatePrice);
      $('download').addEventListener('click', downloadPDF);
      $('showSettings').addEventListener('click', () => $('settings').classList.add('active'));
      $('closeSettings').addEventListener('click', () => $('settings').classList.remove('active'));
      $('cancelSettings').addEventListener('click', () => $('settings').classList.remove('active'));
      $('saveSettings').addEventListener('click', () => { $('settings').classList.remove('active'); showNotification('Settings saved!','success'); });
      // real-time validation
      document.querySelectorAll('input[type=number]').forEach(i => i.addEventListener('input', () => {
        $('calculate').disabled = !validateAllInputs();
      }));
    });
  </script>
</body>
</html>
